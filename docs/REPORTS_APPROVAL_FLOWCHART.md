# ğŸ“Š Expense Reports Approval Process - Complete Flowchart

## Overview
This document describes the complete approval workflow for Travel Expense Reports in the Viaticos 2025 system.

---

## ğŸ”„ Complete Approval Flow Diagram

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         EMPLOYEE CREATES REPORT                             â”‚
â”‚                              (Status: PENDING)                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                â”‚
                                â–¼
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚  Employee Submits for â”‚
                    â”‚  Approval             â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                â”‚
                                â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    STAGE 1: SUPERVISOR APPROVAL                             â”‚
â”‚                        (Status: SUPERVISOR_PENDING)                         â”‚
â”‚                                                                             â”‚
â”‚  Approver: Direct Supervisor (MANAGER profile)                              â”‚
â”‚  Actions:  - Quick Approve All                                              â”‚
â”‚            - Approve All                                                    â”‚
â”‚            - Reject Report                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                â”‚
                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                â–¼                               â–¼
         âœ… APPROVED                      âŒ REJECTED
                â”‚                               â”‚
                â”‚                               â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º REJECTED (Final)
                â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   STAGE 2: ACCOUNTING APPROVAL                              â”‚
â”‚                       (Status: ACCOUNTING_PENDING)                          â”‚
â”‚                                                                             â”‚
â”‚  Approver: Accounting Team (ACCOUNTING profile)                             â”‚
â”‚  Actions:  - Review individual expenses                                     â”‚
â”‚            - Approve/Reject each expense                                    â”‚
â”‚            - Generate SAP Compensation File                                 â”‚
â”‚            - Complete Accounting Approval with SAP #                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                â”‚
                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                â–¼                                â–¼
         âœ… APPROVED                       âŒ REJECTED
                â”‚                                â”‚
                â”‚                                â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º REJECTED (Final)
                â”‚
                â”‚ (Accounting completes with SAP compensation number)
                â”‚
                â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚  BUSINESS LOGIC: Compare Total vs Prepaid â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚           â”‚                               â”‚
    â–¼           â–¼                               â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ EQUAL  â”‚  â”‚  OVER   â”‚                â”‚  UNDER       â”‚
â”‚ BUDGET â”‚  â”‚ BUDGET  â”‚                â”‚  BUDGET      â”‚
â””â”€â”€â”€â”¬â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜                â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
    â”‚            â”‚                             â”‚
    â”‚            â”‚                             â”‚
    â–¼            â–¼                             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ APPROVED_  â”‚ â”‚ APPROVED_FOR_        â”‚  â”‚ FUNDS_RETURN_PENDING   â”‚
â”‚ EXPENSES   â”‚ â”‚ REIMBURSEMENT        â”‚  â”‚                        â”‚
â”‚ (Final)    â”‚ â”‚ (Needs Treasury)     â”‚  â”‚ (Employee Action Req.) â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â”‚                       â”‚
                          â”‚                       â”‚ Employee submits
                          â”‚                       â”‚ fund return docs
                          â”‚                       â”‚
                          â”‚                       â–¼
                          â”‚              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                          â”‚              â”‚  REVIEW_RETURN      â”‚
                          â”‚              â”‚  (Treasury Review)  â”‚
                          â”‚              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â”‚                        â”‚
                          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                       â”‚
                                       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   STAGE 3: TREASURY APPROVAL                                â”‚
â”‚          (Status: APPROVED_FOR_REIMBURSEMENT or REVIEW_RETURN)              â”‚
â”‚                                                                             â”‚
â”‚  Approver: Treasury Team (TREASURY profile)                                 â”‚
â”‚  Actions:  - Approve Reimbursement                                          â”‚
â”‚            - Approve Fund Return                                            â”‚
â”‚            - Reject (sends back for resubmission if REVIEW_RETURN)          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                â”‚
                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                â–¼                               â–¼
         âœ… APPROVED                      âŒ REJECTED
                â”‚                               â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                  â”‚
    â–¼                       â–¼                   â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚ APPROVED_      â”‚  â”‚ APPROVED_RETURNED_   â”‚   â”‚
â”‚ REPAID         â”‚  â”‚ FUNDS                â”‚   â”‚
â”‚ (Reimbursement)â”‚  â”‚ (Fund Return)        â”‚   â”‚
â”‚ (Final)        â”‚  â”‚ (Final)              â”‚   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
                                               â”‚
                                               â”‚ (If REVIEW_RETURN rejected)
                                               â–¼
                                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                    â”‚ FUNDS_RETURN_PENDING   â”‚
                                    â”‚ (Re-submit docs)       â”‚
                                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ“‹ Status Definitions

### **Employee Statuses**
| Status | Description | Who Can Act |
|--------|-------------|-------------|
| `PENDING` | Report created, not yet submitted | Employee (owner) |
| `REJECTED` | Report rejected by any approver | Employee (can resubmit) |
| `FUNDS_RETURN_PENDING` | Employee must submit fund return documents | Employee (owner) |

### **Approval Workflow Statuses**
| Status | Description | Approver | Next Action |
|--------|-------------|----------|-------------|
| `SUPERVISOR_PENDING` | Awaiting supervisor/manager approval | Direct Supervisor (MANAGER) | Approve â†’ ACCOUNTING_PENDING<br>Reject â†’ REJECTED |
| `ACCOUNTING_PENDING` | Awaiting accounting approval | Accounting Team | Approve â†’ (Business Logic) |
| `REVIEW_RETURN` | Treasury reviewing fund return documents | Treasury Team | Approve â†’ APPROVED_RETURNED_FUNDS<br>Reject â†’ FUNDS_RETURN_PENDING |
| `APPROVED_FOR_REIMBURSEMENT` | Awaiting treasury to process reimbursement | Treasury Team | Approve â†’ APPROVED_REPAID |

### **Final Statuses**
| Status | Description | Meaning |
|--------|-------------|---------|
| `APPROVED_EXPENSES` | All expenses approved, amounts match | âœ… Process complete (no treasury needed) |
| `APPROVED_REPAID` | Reimbursement approved and processed | âœ… Process complete (overpayment returned to employee) |
| `APPROVED_RETURNED_FUNDS` | Fund return approved | âœ… Process complete (underspending funds returned) |
| `REJECTED` | Report rejected | âŒ Process terminated (can be resubmitted) |

---

## ğŸ”€ Business Logic Decision Points

### **After Accounting Approval**

The system automatically determines the next status based on expense totals vs. prepayment:

```python
total_expenses = sum(all_approved_expenses)
prepaid_amount = prepayment.amount  # 0 for reimbursement reports

if prepayment_exists AND total_expenses == prepaid_amount:
    âœ… APPROVED_EXPENSES (Final - No treasury needed)
    
elif total_expenses > prepaid_amount:
    â© APPROVED_FOR_REIMBURSEMENT (Needs treasury to pay difference)
    
else:  # total_expenses < prepaid_amount
    â© FUNDS_RETURN_PENDING (Employee must return excess funds)
```

---

## ğŸ‘¥ Approver Permissions

| Role | Profile | Can Approve Status |
|------|---------|-------------------|
| **Supervisor** | `MANAGER` | `SUPERVISOR_PENDING` (only their direct reports) |
| **Accounting** | `ACCOUNTING` | `ACCOUNTING_PENDING` |
| **Treasury** | `TREASURY` | `APPROVED_FOR_REIMBURSEMENT`, `REVIEW_RETURN` |
| **Superuser** | Any + `is_superuser=true` | All statuses (override) |

---

## ğŸ”„ Special Workflows

### **Fund Return Process**
When expenses are less than prepayment:

1. **Accounting approves** â†’ Status: `FUNDS_RETURN_PENDING`
2. **Employee uploads** return documents (receipt, document #) â†’ Status: `REVIEW_RETURN`
3. **Treasury reviews** documents:
   - âœ… Approve â†’ `APPROVED_RETURNED_FUNDS` (Final)
   - âŒ Reject â†’ Back to `FUNDS_RETURN_PENDING` (resubmit)

### **Reimbursement Process**
When expenses exceed prepayment:

1. **Accounting approves** â†’ Status: `APPROVED_FOR_REIMBURSEMENT`
2. **Treasury processes** payment â†’ Status: `APPROVED_REPAID` (Final)

### **Quick Approval**
Supervisors and Treasury can use "Quick Approve" to approve all expenses at once without individual review.

---

## ğŸ“„ SAP Integration

### **Accounting Stage**
- Generate SAP Compensation File (text file with expense data)
- Enter SAP Compensation Number
- Complete approval (triggers business logic)

### **SAP File Contents**
The SAP compensation file includes:
- Company header
- Expense lines (FACTURA first, then BOLETA)
- Document types: `COMPENSACION` (without accent)
- Conditional SAP code (empty if expenses approved, requesting user's SAP code otherwise)

---

## ğŸ¯ Key Business Rules

1. **Submission Requirements**:
   - Report must have at least one expense
   - Credit card imported expenses must be complete (category, purpose, document #)

2. **Supervisor Approval**:
   - Must be direct supervisor of requesting employee
   - Can quick approve or approve all

3. **Accounting Approval**:
   - Can approve/reject individual expenses
   - Must generate SAP file before completing
   - Must enter SAP compensation number

4. **Treasury Approval**:
   - Only triggered for over/under budget reports
   - Equal budget reports skip treasury

5. **Rejection**:
   - Any stage can reject the entire report
   - Rejected reports return to `REJECTED` status
   - Employee can resubmit after corrections
   - Special case: Fund return rejection sends back to `FUNDS_RETURN_PENDING`

---

## ğŸ“§ Email Notifications

Email notifications are sent asynchronously for:
- Report submitted for approval
- Report approved (at each stage)
- Report rejected
- Fund return documents required
- Reimbursement approved

---

## ğŸ“Š Approval History

All approval actions are logged in `approval_history` table:
- Entity type: `TRAVEL_EXPENSE_REPORT`
- User who acted
- Action: `SUBMITTED`, `APPROVED`, `REJECTED`
- Status transition (from â†’ to)
- Comments
- Timestamp

---

## ğŸ” Quick Reference

### Status Flow (Linear Path - Happy Case)
```
PENDING 
  â†’ SUPERVISOR_PENDING 
    â†’ ACCOUNTING_PENDING 
      â†’ APPROVED_EXPENSES (if equal budget)
```

### Status Flow (Over Budget Path)
```
PENDING 
  â†’ SUPERVISOR_PENDING 
    â†’ ACCOUNTING_PENDING 
      â†’ APPROVED_FOR_REIMBURSEMENT 
        â†’ APPROVED_REPAID
```

### Status Flow (Under Budget Path)
```
PENDING 
  â†’ SUPERVISOR_PENDING 
    â†’ ACCOUNTING_PENDING 
      â†’ FUNDS_RETURN_PENDING 
        â†’ REVIEW_RETURN 
          â†’ APPROVED_RETURNED_FUNDS
```

---

**Last Updated**: September 30, 2025  
**System Version**: Viaticos 2025 v1.0  
**Domain**: https://amcor-viaticos2025.tech-labs.org
