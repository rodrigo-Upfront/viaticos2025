# ðŸš€ Viaticos 2025 - DigitalOcean Deployment Guide

## Prerequisites

1. **DigitalOcean Account**: Sign up at [digitalocean.com](https://digitalocean.com)
2. **GitHub Repository**: Push your code to GitHub
3. **DigitalOcean CLI (doctl)**: Install for command-line deployment

## Installation of DigitalOcean CLI

### macOS
```bash
brew install doctl
```

### Linux/Windows
Download from: https://github.com/digitalocean/doctl/releases

## Authentication

1. **Create API Token**:
   - Go to DigitalOcean â†’ API â†’ Generate New Token
   - Copy the token

2. **Authenticate doctl**:
   ```bash
   doctl auth init
   # Paste your API token when prompted
   ```

## Deployment Methods

### Method 1: Using DigitalOcean CLI (Recommended)

1. **Deploy the App**:
   ```bash
   doctl apps create .do/app.yaml
   ```

2. **Monitor Deployment**:
   ```bash
   doctl apps list
   doctl apps get <app-id>
   ```

### Method 2: Using DigitalOcean Web Interface

1. **Go to App Platform**:
   - Log into DigitalOcean
   - Navigate to "Apps" â†’ "Create App"

2. **Connect GitHub**:
   - Choose "GitHub" as source
   - Authorize DigitalOcean to access your repository
   - Select your `viaticos2025` repository

3. **Configure Services**:
   - The `.do/app.yaml` will be automatically detected
   - Review and modify settings if needed

4. **Set Environment Variables**:
   - `DATABASE_URL`: Will be auto-generated by managed database
   - `JWT_SECRET_KEY`: Generate a strong secret key

5. **Deploy**:
   - Click "Create Resources"
   - Wait for deployment to complete

## Required Environment Variables

### Backend Environment Variables
```
DATABASE_URL=postgresql://user:password@host:port/database  # Auto-generated
JWT_SECRET_KEY=your-super-secret-jwt-key-here              # Generate strong key
JWT_ALGORITHM=HS256
ACCESS_TOKEN_EXPIRE_MINUTES=60
REFRESH_TOKEN_EXPIRE_DAYS=7
UPLOAD_PATH=/app/storage/uploads
EXPORT_PATH=/app/storage/exports
MAX_FILE_SIZE=10485760
```

### Frontend Environment Variables
```
REACT_APP_API_URL=https://your-app-name-backend.ondigitalocean.app/api
REACT_APP_UPLOAD_MAX_SIZE=10485760
GENERATE_SOURCEMAP=false
```

## Post-Deployment Setup

### 1. Create Initial Super Admin User

Connect to your backend service and run:
```bash
# Get app info
doctl apps get <app-id>

# Connect to backend container
doctl apps logs <app-id> --type run

# Or create via API call
curl -X POST "https://your-app-backend.ondigitalocean.app/api/users/" \
  -H "Content-Type: application/json" \
  -d '{
    "email": "admin@yourcompany.com",
    "name": "System",
    "surname": "Administrator", 
    "password": "ChangeMe123!",
    "sap_code": "ADMIN001",
    "country_id": 1,
    "cost_center": "ADMIN",
    "profile": "employee",
    "is_superuser": true,
    "is_approver": true,
    "force_password_change": true
  }'
```

### 2. Add Initial Countries

```bash
# Peru
curl -X POST "https://your-app-backend.ondigitalocean.app/api/countries/" \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer <admin-token>" \
  -d '{"name": "Peru", "currency": "PEN"}'

# Chile  
curl -X POST "https://your-app-backend.ondigitalocean.app/api/countries/" \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer <admin-token>" \
  -d '{"name": "Chile", "currency": "CLP"}'
```

### 3. Add Initial Expense Category

```bash
curl -X POST "https://your-app-backend.ondigitalocean.app/api/categories/" \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer <admin-token>" \
  -d '{"name": "Food", "sap_code": "10001", "alert_amount": 100}'
```

## Custom Domain (Optional)

1. **Add Domain in App Platform**:
   - Go to your app â†’ Settings â†’ Domains
   - Add your custom domain

2. **Update DNS**:
   - Point your domain to the provided CNAME
   - SSL certificates are automatically managed

## Monitoring and Logs

```bash
# View app logs
doctl apps logs <app-id>

# View specific service logs
doctl apps logs <app-id> --type run --component backend

# Monitor app health
doctl apps get <app-id>
```

## Scaling

```bash
# Scale backend instances
doctl apps update <app-id> --spec .do/app.yaml
```

## Costs Estimate

**Basic Setup (Development/Testing)**:
- Backend: Basic ($5/month)
- Frontend: Basic ($5/month)  
- Database: Basic ($15/month)
- **Total: ~$25/month**

**Production Setup**:
- Backend: Professional ($12/month)
- Frontend: Professional ($12/month)
- Database: Professional ($40/month)
- **Total: ~$64/month**

## Troubleshooting

### Common Issues

1. **Build Failures**:
   - Check build logs: `doctl apps logs <app-id> --type build`
   - Verify Dockerfile syntax
   - Ensure all dependencies are in requirements.txt/package.json

2. **Database Connection Issues**:
   - Verify DATABASE_URL environment variable
   - Check database is running and accessible

3. **CORS Issues**:
   - Verify REACT_APP_API_URL points to correct backend URL
   - Check backend CORS configuration

### Getting Help

- DigitalOcean Support: Available 24/7 via ticket system
- Community: DigitalOcean Community Forums
- Documentation: https://docs.digitalocean.com/products/app-platform/

## Security Recommendations

1. **Change Default Passwords**: Update all default credentials
2. **Use Strong JWT Secret**: Generate a secure random key
3. **Enable SSL**: App Platform provides free SSL certificates
4. **Regular Updates**: Keep dependencies updated
5. **Backup Strategy**: Regular database backups via DigitalOcean
